<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mini Games</title>
  <style>
    :root{
      --bg:#0f1226; --panel:#181c39; --accent:#ffd44d; --accent-2:#ffb800; --text:#eef2ff; --muted:#8fa0ff; --shadow: rgba(0,0,0,.35);
      --overlay-bg: rgba(6,8,20,.86);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans";
      color:var(--text);
      background: radial-gradient(1200px 600px at 20% -10%, #26306b 0%, #121633 50%, #0b0e22 100%), var(--bg);
      display:grid; place-items:center; padding:24px;
      font-size: 18px; /* lisibilitÃ© â†‘ */
      -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility;
    }
    .wrap{ width:min(1100px, 95vw); }

    .header{ display:flex; align-items:center; gap:12px; justify-content:space-between; margin-bottom:16px; }
    h1{
      margin:0; font-weight:900; letter-spacing:.5px; text-transform:uppercase;
      font-size: clamp(24px, 3.8vw, 42px);
    }
    .controls{ display:flex; gap:12px; align-items:center; margin-left:auto; }

    button, .game{ -webkit-tap-highlight-color: transparent; }

    /* Start un peu plus gros et placÃ© avant le bouton Son (donc + Ã  gauche) */
    .start{
      background: linear-gradient(180deg, #61ffa7, #0be08f);
      color:#032b1b; font-weight:800; border:none;
      padding:16px 24px;
      border-radius:16px; cursor:pointer;
      box-shadow: 0 6px 0 #049c63, 0 12px 24px var(--shadow);
      transition: transform .12s ease, filter .12s ease, box-shadow .12s ease; letter-spacing: .3px;
      order:-1; /* Start avant Son */
      font-size: clamp(16px, 2.2vw, 22px);
    }
    .start:hover{ transform: translateY(-1px); filter:brightness(1.03) }
    .start:active{ transform: translateY(2px); box-shadow: 0 3px 0 #049c63, 0 6px 16px var(--shadow); }
    .start[disabled]{ opacity:.6; cursor:not-allowed; transform:none; }

    .toggle{ background:#2a2f5b; color:var(--text); border:1px solid #3b4281; padding:10px 12px; border-radius:12px; cursor:pointer; }

    .panel{ background:linear-gradient(180deg, #1b2044, #141836); border-radius:28px; padding:18px; box-shadow: 0 12px 40px var(--shadow); border: 1px solid #2a2f5b; }

    .grid{ display:grid; grid-template-columns: repeat(3, 1fr); gap:16px; }
    @media (max-width: 850px){ .grid{ grid-template-columns: repeat(2, 1fr);} }
    @media (max-width: 520px){ .grid{ grid-template-columns: 1fr;} }

    .game{
      display:flex; align-items:center; justify-content:center; text-align:center;
      padding:20px 14px; min-height:86px;
      border-radius:18px; cursor:pointer; user-select:none;
      background: linear-gradient(180deg, var(--accent) 0%, var(--accent-2) 100%);
      color:#3a2a00; font-weight:900; text-shadow: 0 1px 0 rgba(255,255,255,.4);
      border: 3px solid #d49800; box-shadow: 0 8px 0 #b97f00, 0 14px 20px var(--shadow);
      transition: transform .12s ease, box-shadow .12s ease, filter .12s ease, outline-color .2s ease;
      font-size: clamp(18px, 2.2vw, 26px);
    }
    .game:hover{ transform: translateY(-2px); filter: brightness(1.03); }
    .game:active{ transform: translateY(2px); box-shadow: 0 4px 0 #b97f00, 0 8px 14px var(--shadow); }

    .game.active{
      outline: 4px solid #86f1ff; outline-offset: 2px; filter: saturate(1.2) brightness(1.03);
      animation: glow .6s ease infinite alternate;
    }
    @keyframes glow{
      from{ box-shadow: 0 8px 0 #b97f00, 0 0 20px rgba(134,241,255,.0), 0 14px 20px var(--shadow);}
      to{   box-shadow: 0 8px 0 #b97f00, 0 0 30px rgba(134,241,255,.75), 0 14px 24px var(--shadow);}
    }

    /* Pulse prolongÃ© : on laisse pulser en continu, on lâ€™arrÃªte cÃ´tÃ© JS aprÃ¨s 10 s */
    .game.winner{ animation: winnerPulse 1s ease-in-out infinite; }
    @keyframes winnerPulse{ 0%{ transform: scale(1);} 25%{ transform: scale(1.05);} 50%{ transform: scale(0.98);} 75%{ transform: scale(1.06);} 100%{ transform: scale(1);} }

    .footer{ margin-top:12px; color:var(--muted); font-size:16px; display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .winner-label{ font-weight:700; }

    /* -------- Overlay au-dessus du menu -------- */
    .overlay[hidden]{ display:none !important; }
    .overlay{
      position: fixed; inset: 0; z-index: 9999;
      display: grid; grid-template-rows: auto 1fr auto;
      background: var(--overlay-bg);
      backdrop-filter: blur(2px);
      padding: 16px;
    }
    .overlay-bar{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:10px 12px; background:#15193a; border:1px solid #2a2f5b;
      border-radius:12px; margin-bottom:10px;
    }
    .overlay-title{ font-weight:800; letter-spacing:.3px; }
    .overlay-close{
      background:#2a2f5b; color:var(--text); border:1px solid #3b4281; padding:10px 12px; border-radius:12px; cursor:pointer;
    }
    .overlay-player{
      position: relative; width: min(1100px, 96vw); margin: 0 auto;
      border-radius:18px; border:1px solid #2a2f5b; box-shadow: 0 8px 24px var(--shadow);
      background:#0b0e22;
      aspect-ratio: 16 / 9; /* ratio standard; lâ€™iframe remplit la zone */
      overflow:hidden;
    }
    .overlay-player iframe{ position:absolute; inset:0; width:100%; height:100%; border:0; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1>Mini Games</h1>
      <div class="controls">
        <button id="startBtn" class="start">ðŸŽ² Start</button>
        <button class="toggle" id="soundToggle" aria-pressed="true">ðŸ”Š Sound: on</button>
      </div>
    </div>

    <div class="panel">
      <div id="grid" class="grid" aria-live="polite" aria-label="Mini games list"></div>
    </div>

    <div class="footer">
      <div id="winnerText" class="winner-label"></div>
    </div>
  </div>

  <!-- OVERLAY (au-dessus du menu) -->
  <section id="overlay" class="overlay" hidden aria-modal="true" role="dialog">
    <div class="overlay-bar">
      <div class="overlay-title" id="overlayTitle">Game</div>
      <button class="overlay-close" id="overlayCloseTop">Close</button>
    </div>
    <div class="overlay-player" id="overlayPlayer"></div>
    <div class="overlay-bar" style="margin-top:10px;">
      <div class="overlay-title">Need to go back?</div>
      <button class="overlay-close" id="overlayCloseBottom">Close</button>
    </div>
  </section>

  <script>
    // ---------- Helpers pour Google Drive ----------
    function gdriveFileToPreview(url){
      const m = url.match(/\/file\/d\/([^/]+)/);
      return m ? `https://drive.google.com/file/d/${m[1]}/preview` : url;
    }
    function gdriveFolderEmbed(id){
      return `https://drive.google.com/embeddedfolderview?id=${id}#grid`;
    }

    // ---------- CONFIG ----------
    const GAME_TITLES = [
      'Scattergories', 'Idioms', 'Mysteries', 'Phonetic Blindtest', 'Rhyming Words',
      'Real or Fake Laws', 'Trailer of the Day', 'Tongue Twister', 'Who am I ?',
      '5 Minutes Challenge', 'Pass the Bomb !', 'Fly Swatter Game', 'The Hangman',
      'The Grammar Game', 'Joker'
    ];

    // Iframes / liens Ã  afficher dans lâ€™overlay (clÃ© = libellÃ© normalisÃ©)
    // (normalisation = minuscules + suppression des espaces/ponctuation)
    const EMBEDS = {
      /* Genially */
      'scattergories': `<iframe title="Scattergories" src="https://view.genially.com/66a95f3a60361ed54c26d113" allowscriptaccess="always" allowfullscreen="true" scrolling="yes"></iframe>`,
      'idioms': `<iframe title="Idioms" src="https://view.genially.com/66bf3e81027d765543824bb3" allowscriptaccess="always" allowfullscreen="true" scrolling="yes"></iframe>`,
      'mysteries': `<iframe title="Mysteries" src="https://view.genially.com/66a933c0f65290fb65facc03" allowscriptaccess="always" allowfullscreen="true" scrolling="yes"></iframe>`,
      'phoneticblindtest': `<iframe title="Sounds" src="https://view.genially.com/689e18d821e68bde4480c39a" allowscriptaccess="always" allowfullscreen="true" scrolling="yes"></iframe>`,
      'rhymingwords': `<iframe title="Rhyming words" src="https://view.genially.com/66a93bae5bc73ba1f6b33174" allowscriptaccess="always" allowfullscreen="true" scrolling="yes"></iframe>`,
      'realorfakelaws': `<iframe title="Real or fake laws" src="https://view.genially.com/66a91c4f5bc73ba1f69e641b" allowscriptaccess="always" allowfullscreen="true" scrolling="yes"></iframe>`,

      /* Ceux que tu as redonnÃ©s/corrigÃ©s */
      '5minuteschallenge': `<iframe title="5 minutes sentences" src="https://view.genially.com/66aa2859bac8d52d3dba5d8d" allowscriptaccess="always" allowfullscreen="true" scrolling="yes"></iframe>`,
      'flyswattergame': `<iframe title="1 VS 1 Fly Swatter Game" src="https://view.genially.com/689e5854c0d991a40d2db373" allowscriptaccess="always" allowfullscreen="true" scrolling="yes"></iframe>`,

      /* Autres */
      'whoami': `<iframe title="Who am I" src="https://view.genially.com/66aa226f1a63fcf46e90f337" allowscriptaccess="always" allowfullscreen="true" scrolling="yes"></iframe>`,
      'passthebomb': `<iframe title="Pass the bomb !" src="https://view.genially.com/689e5801e8eb55bb885e47ad" allowscriptaccess="always" allowfullscreen="true" scrolling="yes"></iframe>`,
      'thehangman': `<iframe title="THE HANGMAN" src="https://view.genially.com/689e589357ac5b852cc64b69" allowscriptaccess="always" allowfullscreen="true" scrolling="yes"></iframe>`,

      /* Externes (peuvent parfois refuser lâ€™embed) */
      'tonguetwister': `<iframe title="Tongue Twisters" src="https://wheelofnames.com/3k7-mm5" allowfullscreen="true" scrolling="yes"></iframe>`,
      'traileroftheday': `<iframe title="Trailer of the Day" src="${gdriveFolderEmbed('1-BiVqlbkUv2qAoDzOw33EEbDxBuGiuu3')}" allowfullscreen="true" scrolling="yes"></iframe>`,
      'thegrammargame': `<iframe title="Grammar Challenge" src="${gdriveFileToPreview('https://drive.google.com/file/d/1IJGFrF5dE4XwI5t0z6AJT8Y8sVQ2EJX2/view?usp=drive_link')}" allowfullscreen="true" scrolling="yes"></iframe>`
    };

    // ---------- Ã‰tat & DOM ----------
    const BASE_DELAY = 70, ACCEL_STEPS = 10, MIN_DELAY = 40, SLOWDOWN_STEPS = 22;
    const grid = document.getElementById('grid');
    const startBtn = document.getElementById('startBtn');
    const winnerText = document.getElementById('winnerText');
    const soundToggle = document.getElementById('soundToggle');

    const overlay = document.getElementById('overlay');
    const overlayPlayer = document.getElementById('overlayPlayer');
    const overlayTitle = document.getElementById('overlayTitle');
    const overlayCloseTop = document.getElementById('overlayCloseTop');
    const overlayCloseBottom = document.getElementById('overlayCloseBottom');

    let running = false, current = -1;
    let audioEnabled = true, audioCtx = null;
    let autoOpenTimer = null;        // timer dâ€™ouverture auto (10 s)
    let winnerPulseTimer = null;     // timer pour arrÃªter le pulse aprÃ¨s 10 s
    let lastSelectedLabel = null;

    function normalize(label){
      return label.toLowerCase().replace(/[^a-z0-9]/g,'');
    }

    // ---------- Overlay ----------
    function openOverlay(label){
      const key = normalize(label);
      const html = EMBEDS[key];
      if(!html){ return; }
      overlayTitle.textContent = label;
      overlayPlayer.innerHTML = html;
      overlay.hidden = false;
      document.body.style.overflow = 'hidden';
    }
    function closeOverlay(){
      overlay.hidden = true;
      overlayPlayer.innerHTML = '';
      document.body.style.overflow = '';
    }
    overlay.addEventListener('click', (e)=>{ if(e.target === overlay) closeOverlay(); });
    overlayCloseTop.addEventListener('click', closeOverlay);
    overlayCloseBottom.addEventListener('click', closeOverlay);
    document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && !overlay.hidden) closeOverlay(); });

    // ---------- Grille ----------
    function buildTiles(){
      GAME_TITLES.forEach((t, i) => {
        const btn = document.createElement('button');
        btn.className = 'game'; btn.type = 'button'; btn.dataset.index = i; btn.textContent = t;
        btn.addEventListener('click', () => {
          if (running) return;
          chooseWinner(i); // met Ã  jour lâ€™Ã©tat + pulse
          // Si lâ€™utilisateur clique â†’ on ouvre tout de suite
          if (autoOpenTimer){ clearTimeout(autoOpenTimer); autoOpenTimer = null; }
          if (EMBEDS[normalize(t)]) openOverlay(t);
        });
        grid.appendChild(btn);
      });
    }
    buildTiles();
    const items = Array.from(document.querySelectorAll('.game'));

    // ---------- Son ----------
    function ensureAudio(){ if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); if (audioCtx.state === 'suspended') audioCtx.resume(); }
    soundToggle.addEventListener('click', () => {
      audioEnabled = !audioEnabled;
      soundToggle.textContent = (audioEnabled ? 'ðŸ”Š Sound: on' : 'ðŸ”‡ Sound: off');
      soundToggle.setAttribute('aria-pressed', String(audioEnabled));
      if (audioEnabled) ensureAudio();
    });
    function beep(freq=880, duration=0.05, volume=0.05, type='square'){
      if (!audioEnabled) return; ensureAudio();
      const o=audioCtx.createOscillator(); const g=audioCtx.createGain();
      o.type=type; o.frequency.value=freq; g.gain.value=volume; o.connect(g); g.connect(audioCtx.destination);
      const now=audioCtx.currentTime;
      g.gain.setValueAtTime(0, now); g.gain.linearRampToValueAtTime(volume, now+0.005); g.gain.exponentialRampToValueAtTime(0.0001, now+duration);
      o.start(now); o.stop(now+duration+0.005);
    }
    function tick(){ beep(1100, 0.04, 0.05, 'square'); }
    function winSound(){ [523,659,784,1046].forEach((f,i)=> setTimeout(()=> beep(f,0.07,0.06,'sine'), i*90)); }

    // ---------- Visuels ----------
    function clearActive(){ items.forEach(it => it.classList.remove('active','winner')); }
    function setActive(i){ clearActive(); items[i].classList.add('active'); }
    function chooseWinner(i){
      // nettoie anciens timers dâ€™animation
      if (winnerPulseTimer){ clearTimeout(winnerPulseTimer); winnerPulseTimer = null; }

      clearActive();
      items[i].classList.add('winner'); // pulse (CSS = infinite)
      lastSelectedLabel = items[i].textContent;
      winnerText.textContent = `Selected: ${lastSelectedLabel}`;
      winSound();

      // Laisse pulser 10 s puis arrÃªte lâ€™animation (enlevant la classe)
      winnerPulseTimer = setTimeout(()=>{
        items[i].classList.remove('winner');
        winnerPulseTimer = null;
      }, 10000);
    }

    // ---------- Roulette ----------
    startBtn.addEventListener('click', startRoulette);
    document.addEventListener('keydown', (e) => { if (e.code === 'Space'){ e.preventDefault(); startRoulette(); } });

    function startRoulette(){
      if (running) return;
      // annule timers en cours
      if (autoOpenTimer){ clearTimeout(autoOpenTimer); autoOpenTimer = null; }
      if (winnerPulseTimer){ clearTimeout(winnerPulseTimer); winnerPulseTimer = null; }

      running = true; startBtn.disabled = true; winnerText.textContent = '';
      const total = items.length; const extraSteps = Math.floor(total * (2.5 + Math.random()*2));
      let step = 0; let delay = BASE_DELAY;

      function scheduleNext(){
        if (step < ACCEL_STEPS){
          const t = step/Math.max(1,ACCEL_STEPS);
          delay = BASE_DELAY - (BASE_DELAY - MIN_DELAY)*t;
        } else if (step > extraSteps - SLOWDOWN_STEPS){
          const t = (step - (extraSteps - SLOWDOWN_STEPS)) / SLOWDOWN_STEPS;
          delay = MIN_DELAY + (220 - MIN_DELAY) * (1 - Math.pow(1-t,3));
        }
        setTimeout(loop, delay);
      }
      function loop(){
        current = (current + 1) % total;
        setActive(current);
        tick();
        step++;
        if (step <= extraSteps) scheduleNext();
        else finish();
      }
      function finish(){
        clearActive();
        const label = items[current].textContent;
        items[current].classList.add('winner'); // pulse
        lastSelectedLabel = label;
        winnerText.textContent = `Selected: ${label}`;
        winSound();

        // Auto-ouverture aprÃ¨s 10 s (si on nâ€™a pas cliquÃ© avant)
        if (EMBEDS[normalize(label)]){
          autoOpenTimer = setTimeout(()=>{
            if (overlay.hidden && lastSelectedLabel === label){
              openOverlay(label);
            }
            autoOpenTimer = null;
          }, 10000);
        }

        // arrÃªter le pulse au bout de 10 s (comme demandÃ©)
        if (winnerPulseTimer){ clearTimeout(winnerPulseTimer); }
        const idx = current;
        winnerPulseTimer = setTimeout(()=>{
          items[idx]?.classList.remove('winner');
          winnerPulseTimer = null;
        }, 10000);

        running = false; startBtn.disabled = false;
      }

      scheduleNext();
    }
  </script>
</body>
</html>
